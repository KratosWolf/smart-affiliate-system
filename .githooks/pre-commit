#!/bin/bash

echo "ðŸ” SISTEMA DE VERIFICAÃ‡ÃƒO PRE-COMMIT - SMART AFFILIATE SYSTEM"
echo "=================================================================="
echo ""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Flag para controlar se commit deve ser bloqueado
BLOCK_COMMIT=0

# 1. VerificaÃ§Ã£o de TypeScript (OBRIGATÃ“RIA)
echo -e "${YELLOW}ðŸ” 1/5 Verificando TypeScript...${NC}"
npm run type-check > /tmp/typecheck.log 2>&1

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ ERROS DE TYPESCRIPT ENCONTRADOS!${NC}"
    echo "   ðŸ“ Detalhes em /tmp/typecheck.log"
    cat /tmp/typecheck.log
    BLOCK_COMMIT=1
else
    echo -e "${GREEN}âœ… TypeScript: ZERO ERROS${NC}"
fi

# 2. VerificaÃ§Ã£o de Lint (OBRIGATÃ“RIA)
echo -e "${YELLOW}ðŸ” 2/5 Verificando ESLint...${NC}"
npm run lint > /tmp/lint.log 2>&1

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ ERROS DE LINT ENCONTRADOS!${NC}"
    echo "   ðŸ“ Detalhes em /tmp/lint.log"
    head -20 /tmp/lint.log
    BLOCK_COMMIT=1
else
    echo -e "${GREEN}âœ… ESLint: CÃ³digo limpo${NC}"
fi

# 3. VerificaÃ§Ã£o de ConsistÃªncia do Projeto
echo -e "${YELLOW}ðŸ” 3/5 Verificando consistÃªncia do projeto...${NC}"
if [ -f "./scripts/check-consistency.sh" ]; then
    ./scripts/check-consistency.sh > /tmp/consistency.log 2>&1
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}âŒ PROBLEMAS DE CONSISTÃŠNCIA ENCONTRADOS!${NC}"
        echo "   ðŸ“ Detalhes em /tmp/consistency.log"
        tail -10 /tmp/consistency.log
        BLOCK_COMMIT=1
    else
        echo -e "${GREEN}âœ… ConsistÃªncia: Projeto organizado${NC}"
    fi
else
    echo -e "${YELLOW}âš ï¸  Script de consistÃªncia nÃ£o encontrado${NC}"
fi

# 4. VerificaÃ§Ã£o de Secrets/Credenciais
echo -e "${YELLOW}ðŸ” 4/5 Verificando secrets e credenciais...${NC}"
SECRET_PATTERNS=("password" "secret" "key" "token" "credential" "api_key")
SECRET_FOUND=0

for pattern in "${SECRET_PATTERNS[@]}"; do
    # Verifica arquivos staged
    if git diff --cached --name-only | xargs grep -l "$pattern" 2>/dev/null; then
        echo -e "${RED}âš ï¸  PossÃ­vel secret encontrado: '$pattern'${NC}"
        SECRET_FOUND=1
    fi
done

if [ $SECRET_FOUND -eq 1 ]; then
    echo -e "${RED}âŒ POSSÃVEIS SECRETS ENCONTRADOS!${NC}"
    echo "   ðŸ”’ Revise os arquivos antes de fazer commit"
    echo "   ðŸ”’ Remova credenciais hardcoded"
    BLOCK_COMMIT=1
else
    echo -e "${GREEN}âœ… Secrets: Nenhuma credencial exposta${NC}"
fi

# 5. VerificaÃ§Ã£o de Arquivos Grandes
echo -e "${YELLOW}ðŸ” 5/5 Verificando arquivos grandes...${NC}"
LARGE_FILES=$(git diff --cached --name-only | xargs ls -la 2>/dev/null | awk '$5 > 5242880 {print $9 " (" $5/1024/1024 "MB)"}')

if [ -n "$LARGE_FILES" ]; then
    echo -e "${RED}âŒ ARQUIVOS GRANDES ENCONTRADOS:${NC}"
    echo "$LARGE_FILES"
    echo "   ðŸ“¦ Considere usar Git LFS ou remover estes arquivos"
    BLOCK_COMMIT=1
else
    echo -e "${GREEN}âœ… Tamanho: Todos os arquivos OK${NC}"
fi

echo ""
echo "=================================================================="

# DecisÃ£o final
if [ $BLOCK_COMMIT -eq 1 ]; then
    echo -e "${RED}âŒ COMMIT BLOQUEADO - CorreÃ§Ãµes necessÃ¡rias!${NC}"
    echo ""
    echo -e "${YELLOW}ðŸ”§ Como corrigir:${NC}"
    echo "   â†’ npm run type-check (corrigir erros TS)"
    echo "   â†’ npm run lint:fix (corrigir lint)"
    echo "   â†’ ./scripts/check-consistency.sh (verificar organizaÃ§Ã£o)"
    echo "   â†’ Remover credenciais/secrets expostos"
    echo "   â†’ Remover/otimizar arquivos grandes"
    echo ""
    echo -e "${RED}ðŸš« NÃƒO Ã‰ POSSÃVEL FAZER BYPASS - Sistema de seguranÃ§a obrigatÃ³rio${NC}"
    echo ""
    exit 1
else
    echo -e "${GREEN}ðŸŽ‰ TODAS AS VERIFICAÃ‡Ã•ES PASSARAM!${NC}"
    echo -e "${GREEN}âœ… Commit permitido - CÃ³digo seguro e organizado${NC}"
    echo ""
    
    # Log do commit bem-sucedido
    echo "$(date): Pre-commit checks passed - TypeScript OK, Lint OK, Consistency OK, No secrets, File sizes OK" >> .git/hooks/pre-commit.log
fi