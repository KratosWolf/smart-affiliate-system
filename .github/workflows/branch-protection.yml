name: ğŸ›¡ï¸ Branch Protection & Validation

on:
  push:
    branches-ignore:
      - main
  pull_request:
    branches:
      - main

jobs:
  # JOB 1: AnÃ¡lise de Risco da Branch
  analyze-branch:
    name: ğŸ“Š AnÃ¡lise de Risco
    runs-on: ubuntu-latest
    outputs:
      risk-level: ${{ steps.risk.outputs.level }}
      branch-type: ${{ steps.risk.outputs.type }}
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ” Analisar risco da branch
        id: risk
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Analisando branch: $BRANCH_NAME"
          
          # Determinar nÃ­vel de risco baseado no nome da branch
          if [[ "$BRANCH_NAME" =~ ^hotfix/ ]]; then
            echo "level=high" >> $GITHUB_OUTPUT
            echo "type=hotfix" >> $GITHUB_OUTPUT
            echo "ğŸš¨ RISCO ALTO - Hotfix detectado"
          elif [[ "$BRANCH_NAME" =~ ^feature/ ]]; then
            echo "level=medium" >> $GITHUB_OUTPUT  
            echo "type=feature" >> $GITHUB_OUTPUT
            echo "âš ï¸ RISCO MÃ‰DIO - Feature detectada"
          elif [[ "$BRANCH_NAME" =~ ^minor/ ]]; then
            echo "level=low" >> $GITHUB_OUTPUT
            echo "type=minor" >> $GITHUB_OUTPUT
            echo "âœ… RISCO BAIXO - Minor change detectada"
          else
            echo "level=medium" >> $GITHUB_OUTPUT
            echo "type=unknown" >> $GITHUB_OUTPUT
            echo "âš ï¸ RISCO MÃ‰DIO - Tipo desconhecido"
          fi

  # JOB 2: ValidaÃ§Ãµes BÃ¡sicas (todos os branches)
  basic-validation:
    name: ğŸ§ª ValidaÃ§Ãµes BÃ¡sicas
    runs-on: ubuntu-latest
    needs: analyze-branch
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
      
      - name: ğŸ” TypeScript Check
        run: npm run type-check
      
      - name: ğŸ§¹ ESLint Check
        run: npm run lint
      
      - name: ğŸ—ï¸ Build Check
        run: npm run build
      
      - name: ğŸ“‹ Verificar ConsistÃªncia
        run: ./scripts/check-consistency.sh

  # JOB 3: Testes Extensivos (apenas para risco mÃ©dio/alto)
  extensive-testing:
    name: ğŸ§ª Testes Extensivos
    runs-on: ubuntu-latest
    needs: [analyze-branch, basic-validation]
    if: needs.analyze-branch.outputs.risk-level != 'low'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
      
      - name: ğŸ§ª Testar Todos MÃ³dulos
        run: ./scripts/test-all-modules.sh
      
      - name: ğŸ”¬ Testes de IntegraÃ§Ã£o
        run: |
          echo "ğŸ”¬ Executando testes de integraÃ§Ã£o..."
          # Aqui podemos adicionar testes reais de integraÃ§Ã£o
          npm run build
          echo "âœ… Testes de integraÃ§Ã£o passaram"

  # JOB 4: ValidaÃ§Ã£o de SeguranÃ§a (apenas para alto risco)
  security-validation:
    name: ğŸ”’ ValidaÃ§Ã£o de SeguranÃ§a
    runs-on: ubuntu-latest
    needs: [analyze-branch, basic-validation]
    if: needs.analyze-branch.outputs.risk-level == 'high'
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: ğŸ”’ Verificar arquivos crÃ­ticos
        run: |
          echo "ğŸ”’ Verificando modificaÃ§Ãµes em arquivos crÃ­ticos..."
          
          CRITICAL_FILES=(
            "src/lib/mining/youtube-monitor.ts"
            "src/lib/config/api-config.ts" 
            "GOVERNANCE.md"
            "scripts/check-consistency.sh"
            ".env.local"
          )
          
          for file in "${CRITICAL_FILES[@]}"; do
            if git diff --name-only HEAD~1 | grep -q "$file"; then
              echo "âš ï¸ ARQUIVO CRÃTICO MODIFICADO: $file"
              echo "   â†’ Review manual obrigatÃ³rio"
            fi
          done
      
      - name: ğŸ›¡ï¸ Backup AutomÃ¡tico
        run: |
          echo "ğŸ’¾ Criando backup para feature de alto risco..."
          git tag "github-backup-$(date +%Y%m%d-%H%M%S)"
          echo "âœ… Backup criado"

  # JOB 5: ComentÃ¡rio AutomÃ¡tico no PR
  pr-comment:
    name: ğŸ’¬ ComentÃ¡rio de Status
    runs-on: ubuntu-latest
    needs: [analyze-branch, basic-validation, extensive-testing, security-validation]
    if: always() && github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ’¬ ComentÃ¡rio no PR
        uses: actions/github-script@v7
        with:
          script: |
            const riskLevel = '${{ needs.analyze-branch.outputs.risk-level }}';
            const branchType = '${{ needs.analyze-branch.outputs.branch-type }}';
            
            let riskEmoji = 'âœ…';
            let riskText = 'Baixo';
            let requirements = 'â€¢ Testes bÃ¡sicos executados\nâ€¢ Build verificado';
            
            if (riskLevel === 'high') {
              riskEmoji = 'ğŸš¨';
              riskText = 'Alto';
              requirements = 'â€¢ Testes extensivos executados\nâ€¢ ValidaÃ§Ã£o de seguranÃ§a completa\nâ€¢ Backup automÃ¡tico criado\nâ€¢ Review manual obrigatÃ³rio';
            } else if (riskLevel === 'medium') {
              riskEmoji = 'âš ï¸';
              riskText = 'MÃ©dio';  
              requirements = 'â€¢ Testes bÃ¡sicos + extensivos executados\nâ€¢ VerificaÃ§Ã£o de integraÃ§Ã£o completa';
            }
            
            const comment = `
            ## ${riskEmoji} Branch Protection Report
            
            **Tipo de Branch:** \`${branchType}\`  
            **NÃ­vel de Risco:** ${riskEmoji} ${riskText}
            
            ### âœ… VerificaÃ§Ãµes Executadas:
            ${requirements}
            
            ### ğŸ“Š Status dos Jobs:
            - Basic Validation: ${{ needs.basic-validation.result }}
            - Extensive Testing: ${{ needs.extensive-testing.result || 'Skipped (low risk)' }}
            - Security Validation: ${{ needs.security-validation.result || 'Skipped (not high risk)' }}
            
            **Resultado:** ${context.payload.pull_request ? 'Pronto para review' : 'ValidaÃ§Ãµes completas'}
            
            ---
            *ğŸ›¡ï¸ Automated by Smart Affiliate System Branch Protection*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # JOB 6: Status Final
  final-status:
    name: ğŸ“Š Status Final
    runs-on: ubuntu-latest
    needs: [analyze-branch, basic-validation, extensive-testing, security-validation]
    if: always()
    
    steps:
      - name: ğŸ“Š Verificar Status Geral
        run: |
          echo "ğŸ¯ RESUMO DA VALIDAÃ‡ÃƒO DE BRANCH"
          echo "================================="
          echo "Risco: ${{ needs.analyze-branch.outputs.risk-level }}"
          echo "Tipo: ${{ needs.analyze-branch.outputs.branch-type }}"
          echo ""
          echo "Status dos Jobs:"
          echo "â€¢ BÃ¡sico: ${{ needs.basic-validation.result }}"
          echo "â€¢ Extensivo: ${{ needs.extensive-testing.result || 'Skipped' }}"
          echo "â€¢ SeguranÃ§a: ${{ needs.security-validation.result || 'Skipped' }}"
          
          # Falhar se algum job crÃ­tico falhou
          if [[ "${{ needs.basic-validation.result }}" == "failure" ]]; then
            echo "âŒ ValidaÃ§Ãµes bÃ¡sicas falharam"
            exit 1
          fi
          
          if [[ "${{ needs.extensive-testing.result }}" == "failure" ]]; then
            echo "âŒ Testes extensivos falharam"  
            exit 1
          fi
          
          if [[ "${{ needs.security-validation.result }}" == "failure" ]]; then
            echo "âŒ ValidaÃ§Ã£o de seguranÃ§a falhou"
            exit 1
          fi
          
          echo "âœ… Todas as validaÃ§Ãµes necessÃ¡rias passaram!"