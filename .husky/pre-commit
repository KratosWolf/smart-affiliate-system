#!/bin/sh
# ğŸ›¡ï¸ PRE-COMMIT HOOK - BLOQUEIA COMMITS PROBLEMÃTICOS
# Este hook roda ANTES de cada commit e BLOQUEIA se houver problemas

echo "ğŸ›¡ï¸ Executando verificaÃ§Ãµes obrigatÃ³rias..."
echo "================================================="

# 1. VERIFICAR CONSISTÃŠNCIA DO PROJETO
echo "ğŸ“‹ Verificando consistÃªncia..."
./scripts/check-consistency.sh
if [ $? -ne 0 ]; then
    echo "âŒ COMMIT BLOQUEADO - InconsistÃªncias encontradas!"
    echo "   â†’ Execute: ./scripts/check-consistency.sh"
    echo "   â†’ Corrija os problemas e tente novamente"
    exit 1
fi

# 2. VERIFICAR TYPESCRIPT
echo "ğŸ” Verificando TypeScript..."
npm run type-check
if [ $? -ne 0 ]; then
    echo "âŒ COMMIT BLOQUEADO - Erros de TypeScript!"
    echo "   â†’ Execute: npm run type-check"
    echo "   â†’ Corrija os erros e tente novamente"
    exit 1
fi

# 3. VERIFICAR LINTING
echo "ğŸ§¹ Verificando ESLint..."
npm run lint
if [ $? -ne 0 ]; then
    echo "âŒ COMMIT BLOQUEADO - Erros de linting!"
    echo "   â†’ Execute: npm run lint:fix"
    echo "   â†’ Corrija os erros e tente novamente"
    exit 1
fi

# 4. VERIFICAR BUILD
echo "ğŸ—ï¸ Verificando build..."
npm run build
if [ $? -ne 0 ]; then
    echo "âŒ COMMIT BLOQUEADO - Falha no build!"
    echo "   â†’ Build quebrou - corrija os erros"
    echo "   â†’ Teste localmente com: npm run dev"
    exit 1
fi

# 5. LIMPAR PROCESSOS NPM DUPLICADOS
echo "ğŸ§¹ Limpando processos NPM..."
NPM_COUNT=$(ps aux | grep "npm run dev" | grep -v grep | wc -l)
if [ $NPM_COUNT -gt 1 ]; then
    echo "âš ï¸ Matando $NPM_COUNT processos npm duplicados..."
    pkill -f "npm run dev"
fi

echo "================================================="
echo "âœ… TODAS VERIFICAÃ‡Ã•ES PASSARAM - COMMIT PERMITIDO"
echo "ğŸ‰ CÃ³digo limpo, build OK, consistÃªncia OK"